---
title: "general_process"
output: word_document
date: "2025-10-17"
---

*REMINDER*

Research Questions 
~Are there high-leverage scores?
~Are there ways of grouping scores together into discrete categories by their win probabilities?
~How do win probabilities differ between non-deciding sets and deciding sets? 
-BIG QUESTION: How do win probabilities change as we go through different scores and through different sets? (+ overall match)
GOAL: a comprehensive visual of the change in win probability, the new current win probability 

##Data Cleaning 
Points_final: 27580, 30 variables 
variables: match_id, date, season, conference, home_team, visiting_team, set_number, rally_ud, cu_serving, cu_score_pre, opp_score_pre, d_pre, cu_score_end, opp_score_end, cu_score_diff_end, cu_point_won, deciding_set, rally_importance, close_score, rally_in_match, rall_prop_in_match, run_length, prev_win, final_home_set_score, final_away_set_score, won_set, touches_in_rally, timeout_after_point, substitution_after_point, won_match_rally

Points: 23365 entries , 30 variables (NO NAs)

*Different Dataset Uses*
Use the clean (no NAs) dataset (points) for model fitting, validation, and markov property testing (assumptions).
Use the full dataset (points_final) for descriptive summaries, exploratory visuals, and robustness checks.

##Exploratory Analysis 
matches: 169, seasons: 7, total_rallies: 27580, unique_sets: 628	

General Stats:
CU points wins ~50.36% of all points, regardless of serving.
CU served ~50.19% of the rallies, roughly an equal distribution.
Side-out success ~ 58.35%
CU wins ~ 58.35% of points when receiving the serve(side-out success).
CU wins ~42.04% of points when serving.
CU wins ~58.75% of points when receiving the serve.

#Basic Models 
Logistic regression: glm(formula = y ~ d_pre + I(d_pre^2) + cu_serv, family = binomial(), data = pbp2)

GAM model:Family: binomial Link function: logit  Formula:y ~ s(d_pre) + cu_serv

##Markov Chain Modeling 
1.  **Define the state space.**\
    A state is the pre-rally score and server: $$
    (a,b,s),\quad a=\text{CU points},\; b=\text{opponent points},\; s\in\{\text{CU},\text{Opp}\}.
    $$ Absorbing if $a\ge T$ and $a-b\ge2$ (CU wins) or $b\ge T$ and $b-a\ge2$ (opp wins), with $T=25$ (or $15$ in the deciding set).

2.  **Estimate point-win probabilities.**\
    Fit a logistic model for $$
    p(d,s)=\Pr(\text{CU wins next rally}\mid d,s),
    $$ where $d=a-b$ (score differential) and $s$ is whether CU is serving.

3.  **Map to transitions.**\
    From any non-absorbing $(a,b,s)$:

    -   with probability $p(d,s)$ go to $(a+1,b,\text{CU})$\
    -   with probability $1-p(d,s)$ go to $(a,b+1,\text{Opp})$\
        (Rally winner serves next.)

4.  **Solve the absorbing Markov chain.**\
    Let $W(a,b,s)$ be the probability CU wins the set from $(a,b,s)$. Then $$
    W(a,b,s)=p(d,s)\,W(a+1,b,\mathrm{CU})+\big(1-p(d,s)\big)\,W(a,b+1,\mathrm{Opp}),
    $$ with $W=1$ in CU-win absorbing states and $W=0$ in CU-loss absorbing states. Compute via memoized recursion (DP).

5.  **Attach live win probabilities.**\
    For each rally, compute pre-rally $(a,b)$, serving $s$, and $T$; evaluate $W(a,b,s)$ to get pre-rally set win probability.

6.  **Validate & calibrate.**\
    Use Brier score and reliability plots; check that WP rises after CU-won rallies and falls after losses.

7.  **(Maybe) Extend to match-win probability.**\
    Embed set-level $W$ in a best-of-five framework, tracking sets won until a team reaches three.

More Markov.....
-transition prob -> absorbing prob -> validation checks


##Assumptions Met
Assumptions 

-Independence was checked in regard to Markov assumptions computing lags to  Markov(1) assumption. The probability of winning the next rally depends only on the current score state and which team is serving (not on older history). We test this empirically by adding lagged outcomes to the logistic model and with runs tests; any significant lag effects indicate departures from Markov(1). (Testing lagged outcomes and runs tests helps justify the Markov(1) assumption.)

-Conditional independence of rallies. Conditional on modeled state (score and serve), rally outcomes are assumed independent. Violations (e.g., long momentum runs) may bias transition estimates.

-Stationarity within set type. We assume transition probabilities are stable within set types (non-deciding sets vs deciding sets) and within the season range analyzed. We check this by stratifying by season and set type and using temporal holdouts.

-Model form. The logistic model (p(d, s)) with polynomial in score differential and serving indicator captures the dominant relationship between state and next-rally outcome. We verify goodness-of-fit via Brier score, calibration plots, and Hosmer–Lemeshow test.

-CU as representative. Results from CU matches may not generalize to all collegiate teams — we acknowledge limited external validity.

-(Model calibration: Brier / calibration plot / H-L test)- These support assumptions about model correctness and fit.



NOTES
-not using timeouts, substitutions, rotations (still like could we tho)
-want to use Markov chains for win probabilities by different points 
-then use clustering to group different scores that have similar win probabilities